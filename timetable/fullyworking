<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- defining my filename in the "<"head>", I am able to later on use it in the script -->
    <?php
    session_start(); // Start a new session or resume an existing one
    $usrname = $_SESSION['uid'];
    $filename = $usrname;
    if(isset($_POST['definedName']) && !empty($_POST['definedName'])) {
        $file_name_new = $filename . $_POST['definedName'];
    } else {
        // Set a default file name if the definedName key is not set and is then saved
        $file_name_new = $filename . 'default';
    }
    ?>
    <link rel="stylesheet" href="../styles/timetable.css">
</head>
<form method="post">
<table id="timetable" >
    <tr>
        <th></th>
        <th>Monday</th>
        <th>Tuesday</th>
        <th>Wednesday</th>
        <th>Thursday</th>
        <th>Friday</th>
        <th></th>
    </tr>
    <tr>
        <td>9:00am</td>
        <td><input type="text" name="monday-9am"></td>
        <td><input type="text" name="tuesday-9am"></td>
        <td><input type="text" name="wednesday-9am"></td>
        <td><input type="text" name="thursday-9am"></td>
        <td><input type="text" name="friday-9am"></td>
        <td><button class="delete-button">Delete</button></td>

    </tr>
    </table>
<br>
<!--button to allow the user to add another time slot -->
<button id="add-time-button">Add Time</button>
<br><br>
<button onclick="exportTableToCSV('timetable.csv')">Export Table to CSV</button>
<input class="defName" type="text" name="definedName" id="definedName">

<!--JavaScript function to handle form submission and to delete rows when the delete button is clicked -->
<script>
    // Add an event listener for the "Add Time" button to add a new row to the table
    const addTimeButton = document.querySelector("#add-time-button");
    addTimeButton.addEventListener("click", function() {
    // Add a new row to the table for the additional time slot
    const table = document.querySelector("#timetable");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
        <td><input type="text" name="time"></td>
        <td><input type="text" name="monday"></td>
        <td><input type="text" name="tuesday"></td>
        <td><input type="text" name="wednesday"></td>
        <td><input type="text" name="thursday"></td>
        <td><input type="text" name="friday"></td>
        <td><button class="delete-button">Delete</button></td>
    `;
    table.appendChild(newRow);
    //  event listeners for the delete buttons
    const deleteButtons = document.querySelectorAll(".delete-button");
    deleteButtons.forEach(function(deleteButton) {
        deleteButton.addEventListener("click", function() {
        // Delete the corresponding row when the delete button is clicked
        const row = deleteButton.parentElement.parentElement;
        row.remove();
        });
    });
    });
    //  event listeners for the form submission and table cells to save the timetable data and highlight cells when hovered over
    const form = document.querySelector("#timetable-form");
    form.addEventListener("submit", function(event) {
        event.preventDefault();
    // Add code here to save the form data (e.g., using local storage or an AJAX request)

    });
    const tableCells = document.querySelectorAll("#timetable td");
    tableCells.forEach(function(cell) {
    cell.addEventListener("mouseenter", function() {
        cell.classList.add("highlight");
    });
    cell.addEventListener("mouseleave", function() {
        cell.classList.remove("highlight");
    });
    });
    form.addEventListener("submit", function(event) {
    event.preventDefault();
    // Convert the timetable data into a CSV file
    const rows = document.querySelectorAll("#timetable tr");
    let csvContent = "";
    rows.forEach(function(row) {
    const cells = row.querySelectorAll("td, th");
    let rowData = "";
    cells.forEach(function(cell) {
        rowData += cell.textContent + ",";
    });
    csvContent += rowData + "\r\n";
    });
    // Save the CSV file onto the local desktop with the PHP session "usrname
    const csvBlob = new Blob([csvContent], {type: "text/csv"});
    const link = document.createElement("a");
    link.href = window.URL.createObjectURL(csvBlob);
    link.download = `timetable-${usrname}.csv`;
    link.click();
    console.log(link);
    });
    const cells = row.split(",");
    if (cells.length > 1) { // Skip empty rows
    // Adds a new row to the table for the saved time slot, if necessary
    let time = cells[0];
    let monday = cells[1];
    let tuesday = cells[2];
    let wednesday = cells[3];
    let thursday = cells[4];
    let friday = cells[5];
    if (i >= rows.length - 2) { // Check if the current row is the last row
    const table = document.querySelector("#timetable");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
        <td><input type="text" name="time" value="${time}"></td>
        <td><input type="text" name="monday" value="${monday}"></td>
        <td><input type="text" name="tuesday" value="${tuesday}"></td>
        <td><input type="text" name="wednesday" value="${wednesday}"></td>
        <td><input type="text" name="thursday" value="${thursday}"></td>
        <td><input type="text" name="friday" value="${friday}"></td>
        <td><button class="delete-button">Delete</button></td>
    `;
    table.appendChild(newRow);
    //  event listeners for the delete buttons
    const deleteButtons = document.querySelectorAll(".delete-button");
    deleteButtons.forEach(function(deleteButton) {
        deleteButton.addEventListener("click", function() {
        // Delete the corresponding row when the delete button is clicked
        const row = deleteButton.parentElement.parentElement;
        row.remove();
        });
    });
    } else {
    // Update the existing row with the saved data
    const rows = document.querySelectorAll("#timetable tr");
    const cells = rows[i].querySelectorAll("td input");
    cells[0].value = time;
    cells[1].value = monday;
    cells[2].value = tuesday;
    cells[3].value = wednesday;
    cells[4].value = thursday;
    cells[5].value = friday;
    }
    }

    function exportTableToCSV(filename) {
    var csv = [];
    var rows = document.querySelectorAll("table tr");
    
    for (var i = 0; i < rows.length; i++) {
        var row = [], cols = rows[i].querySelectorAll("td, th");
        
        for (var j = 0; j < cols.length; j++) 
            row.push(cols[j].innerText);
        
        csv.push(row.join(","));        
    }

    // Download CSV file
    downloadCSV(csv.join("\n"), "<?php echo $file_name_new;?>");
    }

    function downloadCSV(csv, filename) {
    var csvFile;
    var downloadLink;

    // CSV file
    csvFile = new Blob([csv], {type: "text/csv"});

    // Download link
    downloadLink = document.createElement("a");

    // File name
    downloadLink.download = filename;

    // Create a link to the file
    downloadLink.href = window.URL.createObjectURL(csvFile);

    // Hide download link
    downloadLink.style.display = "none";

    // Add the link to DOM
    document.body.appendChild(downloadLink);

    // Click download link
    downloadLink.click();
    }
</script>

const deleteButtons = document.querySelectorAll(".delete-button");
deleteButtons.forEach(function(deleteButton) {
    deleteButton.addEventListener("click", function() {
    // Delete the corresponding row when the delete button is clicked
    const row = deleteButton.closest('tr');
    if (row) {
        row.remove();
    }
});